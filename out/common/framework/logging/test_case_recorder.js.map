{"version":3,"sources":["../../../../src/common/framework/logging/test_case_recorder.ts"],"names":["SkipTestCase","now","assert","LogMessageWithStack","LogSeverity","kMaxLogStacks","TestCaseRecorder","finalCaseStatus","Pass","hideStacksBelowSeverity","Warn","startTime","logs","logLinesAtCurrentSeverity","debugging","messagesForPreviouslySeenStacks","Map","constructor","result","start","finish","timeMilliseconds","timems","Math","ceil","status","Skip","injectResult","injectedResult","Object","assign","debug","ex","logImpl","info","skipped","warn","expectationFailed","ExpectFailed","validationFailed","ValidationFailed","threw","ThrewException","level","name","baseException","logMessage","stack","seen","get","incrementTimesSeen","set","log","setStackHidden","push"],"mappings":"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","sourcesContent":["import { SkipTestCase } from '../fixture.js';\nimport { now, assert } from '../util/util.js';\n\nimport { LogMessageWithStack } from './log_message.js';\nimport { LiveTestCaseResult } from './result.js';\n\nenum LogSeverity {\n  Pass = 0,\n  Skip = 1,\n  Warn = 2,\n  ExpectFailed = 3,\n  ValidationFailed = 4,\n  ThrewException = 5,\n}\n\nconst kMaxLogStacks = 2;\n\n/** Holds onto a LiveTestCaseResult owned by the Logger, and writes the results into it. */\nexport class TestCaseRecorder {\n  private result: LiveTestCaseResult;\n  private finalCaseStatus = LogSeverity.Pass;\n  private hideStacksBelowSeverity = LogSeverity.Warn;\n  private startTime = -1;\n  private logs: LogMessageWithStack[] = [];\n  private logLinesAtCurrentSeverity = 0;\n  private debugging = false;\n  /** Used to dedup log messages which have identical stacks. */\n  private messagesForPreviouslySeenStacks = new Map<string, LogMessageWithStack>();\n\n  constructor(result: LiveTestCaseResult, debugging: boolean) {\n    this.result = result;\n    this.debugging = debugging;\n  }\n\n  start(): void {\n    assert(this.startTime < 0, 'TestCaseRecorder cannot be reused');\n    this.startTime = now();\n  }\n\n  finish(): void {\n    assert(this.startTime >= 0, 'finish() before start()');\n\n    const timeMilliseconds = now() - this.startTime;\n    // Round to next microsecond to avoid storing useless .xxxx00000000000002 in results.\n    this.result.timems = Math.ceil(timeMilliseconds * 1000) / 1000;\n\n    // Convert numeric enum back to string (but expose 'exception' as 'fail')\n    this.result.status =\n      this.finalCaseStatus === LogSeverity.Pass\n        ? 'pass'\n        : this.finalCaseStatus === LogSeverity.Skip\n        ? 'skip'\n        : this.finalCaseStatus === LogSeverity.Warn\n        ? 'warn'\n        : 'fail'; // Everything else is an error\n\n    this.result.logs = this.logs;\n  }\n\n  injectResult(injectedResult: LiveTestCaseResult): void {\n    Object.assign(this.result, injectedResult);\n  }\n\n  debug(ex: Error): void {\n    if (!this.debugging) return;\n    this.logImpl(LogSeverity.Pass, 'DEBUG', ex);\n  }\n\n  info(ex: Error): void {\n    this.logImpl(LogSeverity.Pass, 'INFO', ex);\n  }\n\n  skipped(ex: SkipTestCase): void {\n    this.logImpl(LogSeverity.Skip, 'SKIP', ex);\n  }\n\n  warn(ex: Error): void {\n    this.logImpl(LogSeverity.Warn, 'WARN', ex);\n  }\n\n  expectationFailed(ex: Error): void {\n    this.logImpl(LogSeverity.ExpectFailed, 'EXPECTATION FAILED', ex);\n  }\n\n  validationFailed(ex: Error): void {\n    this.logImpl(LogSeverity.ValidationFailed, 'VALIDATION FAILED', ex);\n  }\n\n  threw(ex: Error): void {\n    if (ex instanceof SkipTestCase) {\n      this.skipped(ex);\n      return;\n    }\n    this.logImpl(LogSeverity.ThrewException, 'EXCEPTION', ex);\n  }\n\n  private logImpl(level: LogSeverity, name: string, baseException: Error): void {\n    const logMessage = new LogMessageWithStack(name, baseException);\n\n    // Deduplicate errors with the exact same stack\n    if (!this.debugging && logMessage.stack) {\n      const seen = this.messagesForPreviouslySeenStacks.get(logMessage.stack);\n      if (seen) {\n        seen.incrementTimesSeen();\n        return;\n      }\n      this.messagesForPreviouslySeenStacks.set(logMessage.stack, logMessage);\n    }\n\n    // Final case status should be the \"worst\" of all log entries.\n    if (level > this.finalCaseStatus) this.finalCaseStatus = level;\n\n    // setStackHidden for all logs except `kMaxLogStacks` stacks at the highest severity\n    if (level > this.hideStacksBelowSeverity) {\n      this.logLinesAtCurrentSeverity = 0;\n      this.hideStacksBelowSeverity = level;\n\n      // Go back and setStackHidden for everything of a lower log level\n      for (const log of this.logs) {\n        log.setStackHidden();\n      }\n    }\n    if (level === this.hideStacksBelowSeverity) {\n      this.logLinesAtCurrentSeverity++;\n    }\n    if (level < this.hideStacksBelowSeverity || this.logLinesAtCurrentSeverity > kMaxLogStacks) {\n      logMessage.setStackHidden();\n    }\n\n    this.logs.push(logMessage);\n  }\n}\n"],"file":"test_case_recorder.js"}