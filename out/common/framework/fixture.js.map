{"version":3,"sources":["../../../src/common/framework/fixture.ts"],"names":["assert","SkipTestCase","Error","Fixture","eventualExpectations","numOutstandingAsyncExpectations","constructor","rec","params","_params","init","debug","msg","skip","finalize","length","previousExpectations","Promise","all","warn","fail","expectationFailed","immediateAsyncExpectation","fn","ret","eventualAsyncExpectation","promise","push","expectErrorValue","expectedName","ex","niceStack","message","actualName","name","shouldResolve","p","m","shouldReject","shouldThrow","expect","cond"],"mappings":"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","sourcesContent":["import { TestCaseRecorder } from './logging/test_case_recorder.js';\nimport { CaseParams } from './params_utils.js';\nimport { assert } from './util/util.js';\n\nexport class SkipTestCase extends Error {}\n\n// A Fixture is a class used to instantiate each test case at run time.\n// A new instance of the Fixture is created for every single test case\n// (i.e. every time the test function is run).\nexport class Fixture {\n  private _params: unknown;\n  protected rec: TestCaseRecorder;\n  private eventualExpectations: Array<Promise<unknown>> = [];\n  private numOutstandingAsyncExpectations = 0;\n\n  constructor(rec: TestCaseRecorder, params: CaseParams) {\n    this.rec = rec;\n    this._params = params;\n  }\n\n  get params(): unknown {\n    return this._params;\n  }\n\n  // This has to be a member function instead of an async `createFixture` function, because\n  // we need to be able to ergonomically override it in subclasses.\n  async init(): Promise<void> {}\n\n  debug(msg: string): void {\n    this.rec.debug(new Error(msg));\n  }\n\n  skip(msg: string): never {\n    throw new SkipTestCase(msg);\n  }\n\n  async finalize(): Promise<void> {\n    assert(\n      this.numOutstandingAsyncExpectations === 0,\n      'there were outstanding immediateAsyncExpectations (e.g. expectUncapturedError) at the end of the test'\n    );\n\n    // Loop to exhaust the eventualExpectations in case they chain off each other.\n    while (this.eventualExpectations.length) {\n      const previousExpectations = this.eventualExpectations;\n      this.eventualExpectations = [];\n\n      await Promise.all(previousExpectations);\n    }\n  }\n\n  warn(msg?: string): void {\n    this.rec.warn(new Error(msg));\n  }\n\n  fail(msg?: string): void {\n    this.rec.expectationFailed(new Error(msg));\n  }\n\n  protected async immediateAsyncExpectation<T>(fn: () => Promise<T>): Promise<T> {\n    this.numOutstandingAsyncExpectations++;\n    const ret = await fn();\n    this.numOutstandingAsyncExpectations--;\n    return ret;\n  }\n\n  protected eventualAsyncExpectation<T>(fn: (niceStack: Error) => Promise<T>): Promise<T> {\n    const promise = fn(new Error());\n    this.eventualExpectations.push(promise);\n    return promise;\n  }\n\n  private expectErrorValue(expectedName: string, ex: unknown, niceStack: Error): void {\n    if (!(ex instanceof Error)) {\n      niceStack.message = `THREW non-error value, of type ${typeof ex}: ${ex}`;\n      this.rec.expectationFailed(niceStack);\n      return;\n    }\n    const actualName = ex.name;\n    if (actualName !== expectedName) {\n      niceStack.message = `THREW ${actualName}, instead of ${expectedName}: ${ex}`;\n      this.rec.expectationFailed(niceStack);\n    } else {\n      niceStack.message = `OK: threw ${actualName}: ${ex.message}`;\n      this.rec.debug(niceStack);\n    }\n  }\n\n  shouldResolve(p: Promise<unknown>, msg?: string): void {\n    this.eventualAsyncExpectation(async niceStack => {\n      const m = msg ? ': ' + msg : '';\n      try {\n        await p;\n        niceStack.message = 'resolved as expected' + m;\n      } catch (ex) {\n        niceStack.message = `REJECTED${m}\\n${ex.message}`;\n        this.rec.expectationFailed(niceStack);\n      }\n    });\n  }\n\n  shouldReject(expectedName: string, p: Promise<unknown>, msg?: string): void {\n    this.eventualAsyncExpectation(async niceStack => {\n      const m = msg ? ': ' + msg : '';\n      try {\n        await p;\n        niceStack.message = 'DID NOT REJECT' + m;\n        this.rec.expectationFailed(niceStack);\n      } catch (ex) {\n        niceStack.message = 'rejected as expected' + m;\n        this.expectErrorValue(expectedName, ex, niceStack);\n      }\n    });\n  }\n\n  shouldThrow(expectedName: string, fn: () => void, msg?: string): void {\n    const m = msg ? ': ' + msg : '';\n    try {\n      fn();\n      this.rec.expectationFailed(new Error('DID NOT THROW' + m));\n    } catch (ex) {\n      this.expectErrorValue(expectedName, ex, new Error(m));\n    }\n  }\n\n  expect(cond: boolean, msg?: string): boolean {\n    if (cond) {\n      const m = msg ? ': ' + msg : '';\n      this.rec.debug(new Error('expect OK' + m));\n    } else {\n      this.rec.expectationFailed(new Error(msg));\n    }\n    return cond;\n  }\n}\n"],"file":"fixture.js"}